<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width">
<title>Delhi Monopoly</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
#board{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.tile{background:#fff;border-radius:8px;padding:6px;position:relative;min-height:80px}
.color{height:6px;border-radius:6px 6px 0 0}
.owner{
  position:absolute;top:6px;right:6px;
  background:#000;color:#fff;border-radius:50%;
  width:20px;height:20px;text-align:center;font-size:12px
}
.house{font-size:12px;color:green}

#buyModal{
  display:none;
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:15px;
  border:2px solid #333;
  border-radius:10px;
  z-index:1000;
}
</style>
</head>

<body>

<h2>Delhi Monopoly</h2>

<input id="name" placeholder="Name">
<button onclick="join()">Join</button>
<button onclick="roll()">ðŸŽ² Roll</button>

<h3 id="turn">Waiting for playersâ€¦</h3>

<div id="board"></div>

<div id="buyModal">
  <p>Buy this property?</p>
  <button onclick="buy()">Buy</button>
</div>

<script>
/* ========= SOCKET SETUP (FIXED) ========= */
const socket = io();
let myId = null;
let state = null;

socket.on("connect", () => {
  myId = socket.id;
});

/* ========= ACTIONS ========= */
function join(){
  const n = document.getElementById("name").value.trim();
  if(!n){
    alert("Enter name");
    return;
  }
  socket.emit("join", n);
}

function roll(){
  if(!state || !state.players || !state.players.some(p => p.id === myId)){
    alert("Join game first");
    return;
  }
  socket.emit("roll");
}

function buy(){
  socket.emit("buy");
}

/* ========= STATE LISTENER ========= */
socket.on("state", s => {
  state = s;
  render();
});

/* ========= RENDER ========= */
function render(){
  const boardDiv = document.getElementById("board");
  const turnDiv  = document.getElementById("turn");
  const modal    = document.getElementById("buyModal");

  // No players yet
  if(!state || !state.players || state.players.length === 0){
    turnDiv.innerText = "Waiting for playersâ€¦";
    boardDiv.innerHTML = "";
    modal.style.display = "none";
    return;
  }

  // Safe turn text (NO null)
  const current = state.players[state.turn];
  turnDiv.innerText = current ? current.name + "'s turn" : "Waiting for turnâ€¦";

  boardDiv.innerHTML = "";

  state.board.forEach((t,i)=>{
    const d = document.createElement("div");
    d.className = "tile";

    if(t.color){
      const c = document.createElement("div");
      c.className = "color";
      c.style.background = t.color;
      d.appendChild(c);
    }

    d.innerHTML += `<b>${t.name}</b><br>${t.price ? "â‚¹"+t.price : ""}`;

    // Owner badge
    if(t.owner){
      const o = document.createElement("div");
      o.className = "owner";
      const p = state.players.find(pl => pl.id === t.owner);
      o.innerText = p ? p.name[0] : "?";
      d.appendChild(o);
    }

    // Houses
    if(t.houses > 0){
      const h = document.createElement("div");
      h.className = "house";
      h.innerText = "ðŸ ".repeat(t.houses);
      d.appendChild(h);
    }

    // Build house button (unchanged logic)
    if(
      t.owner === myId &&
      t.color
    ){
      const sameColor = state.board.filter(b => b.color === t.color);
      if(sameColor.length > 0 && sameColor.every(b => b.owner === myId)){
        const btn = document.createElement("button");
        btn.innerText = "Build House";
        btn.onclick = () => socket.emit("buildHouse", i);
        d.appendChild(btn);
      }
    }

    boardDiv.appendChild(d);
  });

  // Buy popup
  modal.style.display = state.awaitingBuy ? "block" : "none";
}
</script>

</body>
</html>
