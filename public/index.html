<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width">
<title>Delhi Monopoly</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
#board{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.tile{background:#fff;border-radius:8px;padding:6px;position:relative;min-height:90px}
.color{height:6px;border-radius:6px 6px 0 0}

.owner{
  position:absolute;top:6px;right:6px;
  background:#000;color:#fff;border-radius:50%;
  width:20px;height:20px;text-align:center;font-size:12px
}

.tokens{
  position:absolute;bottom:4px;left:4px;
  display:flex;gap:4px;flex-wrap:wrap
}
.token{
  width:16px;height:16px;border-radius:50%;
  background:#333;color:#fff;font-size:10px;
  display:flex;align-items:center;justify-content:center
}

.house{font-size:12px;color:green}

#players{
  margin-top:10px
}
.playerBox{
  background:#fff;border-radius:8px;
  padding:6px;margin-bottom:6px;
  box-shadow:0 1px 3px rgba(0,0,0,.2)
}

#buyModal{
  display:none;
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:15px;
  border:2px solid #333;
  border-radius:10px;
  z-index:1000;
}
</style>
</head>

<body>

<h2>Delhi Monopoly</h2>

<input id="name" placeholder="Name">
<button onclick="join()">Join</button>
<button onclick="roll()">üé≤ Roll</button>

<h3 id="turn">Waiting for players‚Ä¶</h3>

<div id="board"></div>

<div id="players"></div>

<div id="buyModal">
  <p id="buyText"></p>
  <button onclick="buy()">Buy</button>
</div>

<script>
/* ========= SOCKET ========= */
const socket = io();
let myId = null;
let state = null;

socket.on("connect", () => {
  myId = socket.id;
});

/* ========= ACTIONS ========= */
function join(){
  const n = name.value.trim();
  if(!n){ alert("Enter name"); return; }
  socket.emit("join", n);
}
function roll(){
  if(!state || !state.players.some(p=>p.id===myId)){
    alert("Join game first");
    return;
  }
  socket.emit("roll");
}
function buy(){
  socket.emit("buy");
}

/* ========= STATE ========= */
socket.on("state", s=>{
  state = s;
  render();
});

/* ========= RENDER ========= */
function render(){
  const boardDiv = document.getElementById("board");
  const turnDiv  = document.getElementById("turn");
  const modal    = document.getElementById("buyModal");
  const buyText  = document.getElementById("buyText");
  const playersDiv = document.getElementById("players");

  if(!state || state.players.length===0){
    turnDiv.innerText="Waiting for players‚Ä¶";
    boardDiv.innerHTML="";
    playersDiv.innerHTML="";
    modal.style.display="none";
    return;
  }

  const current = state.players[state.turn];
  turnDiv.innerText = current ? current.name+"'s turn" : "Waiting‚Ä¶";

  /* BOARD */
  boardDiv.innerHTML="";
  state.board.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="tile";

    if(t.color){
      const c=document.createElement("div");
      c.className="color";
      c.style.background=t.color;
      d.appendChild(c);
    }

    d.innerHTML+=`<b>${t.name}</b><br>${t.price?"‚Çπ"+t.price:""}`;

    /* owner badge */
    if(t.owner){
      const o=document.createElement("div");
      o.className="owner";
      const p=state.players.find(pl=>pl.id===t.owner);
      o.innerText=p ? p.name[0] : "?";
      d.appendChild(o);
    }

    /* houses */
    if(t.houses>0){
      const h=document.createElement("div");
      h.className="house";
      h.innerText="üè†".repeat(t.houses);
      d.appendChild(h);
    }

    /* tokens */
    const tokenBox=document.createElement("div");
    tokenBox.className="tokens";
    state.players.forEach(p=>{
      if(p.pos===i){
        const tok=document.createElement("div");
        tok.className="token";
        tok.innerText=p.name[0];
        tokenBox.appendChild(tok);
      }
    });
    d.appendChild(tokenBox);

    /* build house button */
    if(t.owner===myId && t.color){
      const sameColor=state.board.filter(b=>b.color===t.color);
      if(sameColor.length>0 && sameColor.every(b=>b.owner===myId)){
        const btn=document.createElement("button");
        btn.innerText="Build House";
        btn.onclick=()=>socket.emit("buildHouse",i);
        d.appendChild(btn);
      }
    }

    boardDiv.appendChild(d);
  });

  /* PLAYERS INFO BOX */
  playersDiv.innerHTML="";
  state.players.forEach((p,idx)=>{
    const box=document.createElement("div");
    box.className="playerBox";
    box.innerHTML=`
      <b>${p.name}</b><br>
      üí∞ ‚Çπ${p.money}<br>
      üìç Tile ${p.pos}<br>
      ${idx===state.turn?"‚û°Ô∏è Turn":""}
    `;
    playersDiv.appendChild(box);
  });

  /* BUY POPUP TEXT */
  if(state.awaitingBuy){
    const tile=state.board[state.awaitingBuy.tileIndex];
    buyText.innerHTML=`Buy <b>${tile.name}</b> for ‚Çπ${tile.price}?`;
    modal.style.display="block";
  }else{
    modal.style.display="none";
  }
}
</script>

</body>
</html>
